<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
                 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
                 
<mapper namespace="com.humuson.push2u.push.dao.PushDao">

    <!-- 앱 유저 리스트 가져오기 -->
	<select id="getAppUserList" resultType="java.util.Map">
		SELECT CUST_ID, PHONE_NUM
		FROM APP_USERS;	    
	</select>
	
	<!-- MAX 캠페인 아이디 가져오기 -->
	<select id="getMaxCamId" resultType="int">
	    SELECT MAX(CAM_ID)
		FROM push_campaigns;
	</select>
	
	<!-- MAX 푸시 아이디 가져오기 -->
	<select id="getMaxPushId" resultType="int">
	    SELECT MAX(PUSH_ID)
		FROM push_detail;
	</select>
	
	<!-- 캠페인 정보 INSERT -->
	<insert id="insertCampaign" parameterType="java.util.Map">
	    INSERT INTO push_campaigns (USER_ID, MSG_TYPE, PUSH_TITLE, POPUP_CONTENT, PUSH_MSG, INAPP_CONTENT, REQ_DATE, SMS_YN, SMS_CONTENT, TARGET_CNT)
		VALUES (#{userId}, #{msgType}, #{pushTitle}, #{popupContents}, #{pushMsg}, #{inAppcontents}, SYSDATE(), #{smsYN}, #{smsContents}, #{targetCnt});
	</insert>
	
	<!-- 캠페인 디테일 insert -->
	<insert id="insertPushDetail">
	    INSERT INTO PUSH_DETAIL (CAM_ID, REQ_UID, CUST_ID, RTN_TYPE, RES_DATE)
		VALUES (#{camId}, #{reqUid}, #{custId}, 'N', DATE_FORMAT(SYSDATE(), '%Y%m%d%H%i%s'))
	</insert>
	
	<!-- 푸시 로그 가져오기 -->
	<select id="getPushDetailList" parameterType="int" resultType="java.util.Map">
	    SELECT ID, REQ_UID, CUST_ID, RTN_TYPE, RES_CD, RES_DATE
		FROM TB_SEND_QUE_LOG
		WHERE BIZ_ID = '2fa2cd24481642f190919a4edf64f653'
		AND ID > #{maxPushId};
	</select>
	
	<!-- 푸시 로그 INSERT -->
	<insert id="insertPushLog" parameterType="java.util.Map">
	    INSERT INTO PUSH_DETAIL (CAM_ID, PUSH_ID, REQ_UID, CUST_ID, RTN_TYPE, RES_CD, RES_DATE, SMS_SEND_YN)
	    <choose>
	        <when test='RTN_TYPE.equals("S")'>
	            VALUES (#{CAM_ID}, #{ID}, #{REQ_UID}, #{CUST_ID}, #{RTN_TYPE}, #{RES_CD}, #{RES_DATE}, 'N')
	        </when>
	        <otherwise>
	            VALUES (#{CAM_ID}, #{ID}, #{REQ_UID}, #{CUST_ID}, #{RTN_TYPE}, #{RES_CD}, #{RES_DATE}, NULL)
	        </otherwise>
	    </choose>
	</insert>
	
	<!-- 캠페인 성공, 오픈, 클릭 카운트 증가 -->
	<update id="plusResultCnt" parameterType="java.util.Map">
	    <choose>
	        <when test='RTN_TYPE.equals("S") and RES_CD.equals("1000")'>
	            UPDATE PUSH_CAMPAIGNS
	            SET SUCCESS_CNT = SUCCESS_CNT + 1
	            WHERE CAM_ID = #{CAM_ID}
	        </when>
	        <when test='RTN_TYPE.equals("R")'>
	            UPDATE PUSH_CAMPAIGNS
	            SET OPEN_CNT = OPEN_CNT + 1
	            WHERE CAM_ID = #{CAM_ID}
	        </when>
	        <when test='RTN_TYPE.equals("C")'>
	            UPDATE PUSH_CAMPAIGNS
	            SET CLICK_CNT = CLICK_CNT + 1
	            WHERE CAM_ID = #{CAM_ID}
	        </when>
	        <otherwise>
	            UPDATE PUSH_CAMPAIGNS
	            SET TARGET_CNT = TARGET_CNT
	            WHERE CAM_ID = #{CAM_ID}
	        </otherwise>
	    </choose>
	</update>
	
	<!-- report 리스트 -->
	<select id="getReportList" parameterType="java.util.Map" resultType="java.util.Map">
	    SELECT CAM_ID, PUSH_TITLE, TARGET_CNT, SUCCESS_CNT, OPEN_CNT, CLICK_CNT, SMS_YN 
	    FROM PUSH_CAMPAIGNS
		WHERE USER_ID = #{userId}
		ORDER BY REQ_DATE DESC
		LIMIT #{limit}, 5
	</select>
	
	<select id="allReportSize" parameterType="java.lang.String" resultType="int">
		SELECT COUNT(CAM_ID)
		FROM PUSH_CAMPAIGNS
		WHERE USER_ID = #{userId}
	</select>
	
	<!-- report 상세 화면 -->
	<select id="getDetailReport" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT CAM_ID, PUSH_TITLE, REQ_DATE, TARGET_CNT, SUCCESS_CNT, OPEN_CNT, SUCCESS_CNT - OPEN_CNT NOOPEN_CNT, 
      		   TARGET_CNT - SUCCESS_CNT FAIL_CNT, CLICK_CNT, SMS_YN 
		FROM PUSH_CAMPAIGNS
		WHERE CAM_ID = #{camId}
		AND USER_ID = #{userId};
	</select>
	
	<!-- MAX detail_id 가져오기 -->
	<select id="getMaxDetailId" resultType="int">
	    SELECT MAX(DETAIL_ID)
		FROM SMS_DETAIL;
	</select>
    
	<!-- report 타겟 대상자 화면 -->
	<select id="getTargetList" parameterType="java.util.Map" resultType="java.util.Map">
	    SELECT d.CUST_ID, PHONE_NUM, a.OS_VER, a.DEVICE, a.APP_VER, RTN_TYPE
		FROM push_detail d
		JOIN app_users a ON d.CUST_ID = a.CUST_ID
		JOIN push_campaigns p on p.CAM_ID = d.CAM_ID
		WHERE d.CAM_ID = #{camId}
		AND RTN_TYPE = 'N'
		AND USER_ID = #{userId}
		ORDER BY detail_id DESC
		LIMIT #{limit}, 5		
	</select>
	
	<select id="allTargetSize" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(c.CAM_ID) 
		FROM push_detail d
		JOIN push_campaigns c ON c.CAM_ID = d.CAM_ID 
		WHERE c.CAM_ID = #{camId}
		AND USER_ID = #{userId}
		AND RTN_TYPE = 'N'
	</select>
	
</mapper>